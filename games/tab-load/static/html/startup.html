<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
</head>
<body>
  <div id="video-wrapper">
    <div id="link-article" class="interaction"></div>
    <video id="video-test" preload="auto" width="1366" height="768"></video>
    <div id="step-complete" class="hidden">
      <h1>Animation completed!</h1>
      <p>Would you like to watch it again?</p>
      <button id="reset">Play again</button>
      <button id="end-trial">Continue</button>
    </div>
  <div>

  <script type="text/javascript">
    var vid = document.getElementById('video-test');
    var link_article = document.getElementById('link-article');
    var step_complete = document.getElementById('step-complete');
    var reset = document.getElementById('reset');
    var timeouts = [];

    // pre-load entire video
    var req = new XMLHttpRequest();
    req.open('GET', jsPsych.currentTrial().data.video_url, true);
    req.responseType = 'blob';

    req.onload = function() {
      if (this.status === 200) {
        let videoBlob = this.response;
        let v = URL.createObjectURL(videoBlob);
        vid.src = v;
      }
    };

    req.send();

    var startup = function () {
      link_article.onclick = function () {
        link_article.onclick = null;
        vid.play();
        vid.onended = function(e) {
          timeouts.push(setTimeout(function () {
            step_complete.classList.remove('hidden');
          }, 2000));
        };
      }
      reset.onclick = function() {
        console.log('reset clicked')
        for (var i = 0; i < timeouts.length; i++) {
            clearTimeout(timeouts[i]);
        }
        vid.currentTime = 0;
        vid.pause();
        step_complete.classList.add('hidden');
        timeouts = [];
        startup();
      }
    }
    startup();

  </script>
</body>

</html>
